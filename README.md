# photodrop

A Progressive Web App (PWA) for privately sharing baby photos with family members.

## Prerequisites

- Node.js 18+
- Cloudflare account (free tier works)
- Git

## Infrastructure setup

### Development environment (local testing)

```bash
# Install Wrangler and log in to Cloudflare
npm install -g wrangler
wrangler login

# Set up development resources
npm run setup:dev
```

This creates:
- `photodrop-db-dev` D1 database
- `photodrop-photos-dev` R2 bucket
- `.dev.vars` with generated secrets
- `wrangler.toml` configured for development

### Production environment

```bash
# Set up production resources
npm run setup:prod
```

This creates:
- `photodrop-db-prod` D1 database
- `photodrop-photos-prod` R2 bucket
- `.prod.vars` with generated secrets (for reference)
- Updates `wrangler.toml` with production environment config
- Optionally sets Worker secrets in Cloudflare

**How it works:**
- Development uses `wrangler.toml` (gitignored, generated by setup script)
- Production uses `wrangler.production.toml` (committed to git)
- No config conflicts, clean separation of environments

### GitHub Actions (optional)

For automated deployments on push to main:

1. Run `npm run setup:prod` to create production resources
2. Commit the updated `wrangler.production.toml` to git
3. Add these secrets to GitHub (Settings → Secrets and variables → Actions):
   - `CLOUDFLARE_API_TOKEN`
   - `CLOUDFLARE_ACCOUNT_ID`
   - `JWT_SECRET`
   - `VAPID_PUBLIC_KEY`
   - `VAPID_PRIVATE_KEY`

The setup script prints these values for you to copy.

### Manual setup (if needed)

<details>
<summary>Click to expand manual setup instructions</summary>

#### 1. Install dependencies

```bash
cd backend && npm install
cd ../frontend && npm install
```

#### 2. Create Cloudflare resources

```bash
cd backend
wrangler d1 create photodrop-db
wrangler r2 bucket create photodrop-photos
```

#### 3. Create wrangler.toml

```bash
# Create wrangler.toml with your database_id from step 2
# See wrangler.production.toml for reference structure
```

#### 4. Generate secrets

```bash
openssl rand -base64 32  # JWT_SECRET
npm install -g web-push
web-push generate-vapid-keys
```

#### 5. Create .dev.vars

Create `backend/.dev.vars` with the generated secrets.

#### 6. Run migrations

```bash
wrangler d1 execute photodrop-db --local --file=../migrations/001_initial_schema.sql
wrangler d1 execute photodrop-db --file=../migrations/001_initial_schema.sql
```

</details>

## Local development

After running `npm run setup:dev`:

### Backend

```bash
cd backend
npm run dev  # Starts Wrangler dev server on http://localhost:8787
```

### Frontend

```bash
cd frontend
npm run dev  # Starts Vite dev server on http://localhost:5173
```

The frontend will proxy API requests to the backend automatically.

## Deploying to production

After running `npm run setup:prod`:

### Manual deployment from your machine

```bash
npm run deploy:prod
```

This will:
- Run backend tests
- Deploy Worker to production environment
- Build and deploy frontend to Cloudflare Pages
- Run health check

### Automated deployment via GitHub Actions

Push to main branch:

```bash
git push origin main
```

GitHub Actions will automatically deploy if you've configured the secrets.

## Destroying infrastructure

### Delete development environment only

```bash
npm run teardown:dev
```

### Delete production environment only

```bash
npm run teardown:prod
```

### Delete everything

```bash
npm run teardown
```

**Warning:** These commands permanently delete databases and all data. Use with caution!

## Running tests

### Backend

```bash
cd backend
npm test          # Run tests in watch mode
npm run test:run  # Run tests once
```

### Frontend

```bash
cd frontend
npm test          # Run tests in watch mode
npm run test:ui   # Open Vitest UI
npm run test:run  # Run tests once
```
